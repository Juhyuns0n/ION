<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Workbook Tester (Full UI)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial; }
        body { margin: 24px; background: #0b0b0c; color: #e8e8ea; }
        h1 { font-size: 20px; margin: 0 0 16px; }
        .grid { display: grid; grid-template-columns: minmax(420px, 720px) minmax(300px, 1fr); gap: 16px; align-items: start; }
        .card { background: #121316; border: 1px solid #23252a; border-radius: 14px; padding: 16px; }
        .row { display: flex; gap: 8px; margin: 6px 0; align-items: center; }
        label { width: 120px; color: #b7bac2; font-size: 13px; }
        input, textarea {
            flex: 1; background: #0f1013; border: 1px solid #2a2d34; color: #e8e8ea;
            padding: 8px 10px; border-radius: 10px; outline: none;
        }
        textarea { min-height: 64px; }
        button {
            background: #2f67ff; color: white; border: none; padding: 10px 14px; border-radius: 10px;
            cursor: pointer; font-weight: 600;
        }
        button.secondary { background: #1e2127; }
        .pill { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 999px; background: #181a1f; color: #cdd3df; font-size: 12px; border: 1px solid #282c34; }
        .muted { color: #9aa0aa; font-size: 12px; }
        .log { background: #0a0b0d; border: 1px solid #23252a; padding: 12px; border-radius: 12px; height: 540px; overflow: auto; font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px; }
        .section-title { font-weight: 700; margin: 10px 0 6px; color: #cdd3df; }
        .mcq-option { display: block; width: 100%; text-align: left; margin: 6px 0; padding: 10px 12px; border-radius: 10px; background:#171a20; border:1px solid #2a2d34; cursor:pointer; }
        .mcq-option:hover { background:#1b1f27; }
        .bubble { max-width: 90%; margin: 6px 0; padding: 10px 12px; border-radius: 12px; line-height: 1.4; display:inline-block; }
        .ai   { background:#18202b; border:1px solid #263244; }
        .user { background:#1f1a20; border:1px solid #322634; align-self: flex-end; }
        .col { display:flex; flex-direction:column; gap:6px; }
        .flex { display:flex; gap:8px; }
        hr { border-color:#23252a; }
        ul { margin: 6px 0 0 18px; }
    </style>
</head>
<body>
<h1>ğŸ“˜ Workbook Tester (Spring 8080)</h1>

<div class="grid">
    <!-- ì¢Œì¸¡: UI -->
    <div class="card">
        <!-- ì„¤ì • -->
        <div class="row"><label>Spring Base</label><input id="baseUrl" value="http://127.0.0.1:8080" /></div>
        <div class="row"><label>User ID</label><input id="userId" value="u001" /></div>
        <div class="row"><label>Child Age</label><input id="childAge" type="number" value="4" /></div>
        <div class="row"><label>Topic</label><input id="topic" value="ë–¼ì“°ëŠ” ì•„ì´" /></div>

        <div class="row" style="margin-top:12px;">
            <button id="btnCreate">1) ì›Œí¬ë¶ ìƒì„±</button>
            <button id="btnStart" class="secondary">2) ëŸ° ì‹œì‘</button>
        </div>

        <div class="row" style="gap:12px; margin-top: 12px;">
            <span class="pill">workbookId: <span id="wbId">-</span></span>
            <span class="pill">runId: <span id="runId">-</span></span>
            <span class="pill">step: <span id="step">-</span></span>
        </div>

        <hr>

        <!-- MCQ ì„¹ì…˜ -->
        <div id="mcqSec" style="display:none;">
            <div class="section-title">â‘  MCQ</div>
            <div id="mcqQuestion" class="muted"></div>
            <div id="mcqOptions" class="col" style="margin-top:8px;"></div>
        </div>

        <!-- WRITING ì„¹ì…˜ -->
        <div id="writingSec" style="display:none; margin-top:12px;">
            <div class="section-title">â‘¡ WRITING</div>
            <div id="writingQuestion" class="muted"></div>
            <div class="row"><label>ì˜ˆì‹œ</label><input id="writingExample" readonly></div>
            <div class="row"><label>ë‚´ ë‹µë³€</label><textarea id="writingText">ì§€ê¸ˆ í™”ê°€ ë§ì´ ë‚¬êµ¬ë‚˜. ë„¤ ë§ˆìŒ ì´í•´í•´. ì˜¤ëŠ˜ì€ ì‚¬ì§€ ì•Šê³  ëŒ€ì‹  ì§‘ì—ì„œ ê°™ì´ ë†€ì.</textarea></div>
            <div class="row"><button id="btnSubmitWriting">WRITING ì œì¶œ</button></div>
        </div>

        <!-- SIMULATION ì„¹ì…˜ -->
        <div id="simSec" style="display:none; margin-top:12px;">
            <div class="section-title">â‘¢ SIMULATION</div>
            <div id="situation" class="muted"></div>
            <div id="chat" class="col" style="margin-top:8px;"></div>
            <div class="flex">
                <input id="parentReply" placeholder="ë¶€ëª¨ ë°œí™”ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
                <button id="btnSimNext" class="secondary">ë‹¤ìŒ í„´</button>
            </div>
        </div>

        <!-- FEEDBACK ì„¹ì…˜ -->
        <div id="fbSec" style="display:none; margin-top:12px;">
            <div class="section-title">â‘£ FEEDBACK</div>
            <div id="fbOverall" class="muted" style="white-space:pre-line;"></div>
            <ul id="fbTips"></ul>
        </div>
    </div>

    <!-- ìš°ì¸¡: ë¡œê·¸ -->
    <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center;">
            <div class="section-title" style="margin:0;">Live Log</div>
            <button id="btnClear" class="secondary">ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>
        <div id="log" class="log"></div>
    </div>
</div>

<script>
    const $ = (id) => document.getElementById(id);
    let state = {
        workbookId: null, runId: null, step: null,
        mcq: null, writing: null, situation: null, history: []
    };

    function log(title, obj, kind='INFO') {
        const el = $('log');
        const time = new Date().toLocaleTimeString();
        const pretty = obj !== undefined ? JSON.stringify(obj, null, 2) : '';
        el.innerText += `[${time}] ${kind} ${title}\n${pretty}\n\n`;
        el.scrollTop = el.scrollHeight;
    }
    function setState(partial) {
        state = { ...state, ...partial };
        $('wbId').innerText = state.workbookId ?? '-';
        $('runId').innerText = state.runId ?? '-';
        $('step').innerText = state.step ?? '-';
    }
    function show(id, on=true){ $(id).style.display = on ? '' : 'none'; }
    function disable(id, on=true){ $(id).disabled = on; }

    async function req(path, method='GET', body) {
        const base = $('baseUrl').value.replace(/\/+$/,'');
        const url = base + path;
        const init = { method, headers: { 'Content-Type': 'application/json' } };
        if (body !== undefined) init.body = JSON.stringify(body);
        log(`${method} ${url}`, body, 'REQ');
        const res = await fetch(url, init);
        const text = await res.text();
        let data; try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }
        log(`${res.status} ${res.statusText} â† ${method} ${url}`, data, 'RES');
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}: ${text}`);
        return data;
    }

    // ---- MCQ ----
    function renderMcq(mcq){
        state.mcq = mcq;
        show('mcqSec', true);
        $('mcqQuestion').innerText = mcq.instruction || '(ì§ˆë¬¸ ì—†ìŒ)';
        const wrap = $('mcqOptions');
        wrap.innerHTML = '';
        (mcq.options || []).forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'mcq-option';
            btn.textContent = opt;
            btn.onclick = () => answerMcq(opt);
            wrap.appendChild(btn);
        });
    }
    async function answerMcq(answer){
        if (!state.runId) return alert('ë¨¼ì € ëŸ°ì„ ì‹œì‘í•˜ì„¸ìš”.');
        try {
            const data = await req(`/api/workbooks/runs/${state.runId}/answer/mcq`, 'POST', { answer });
            renderWriting(data);
            setState({ step: 'WRITING' });
        } catch(e){ alert(e.message); }
    }

    // ---- WRITING ----
    function renderWriting(wr){
        state.writing = wr;
        show('writingSec', true);
        $('writingQuestion').innerText = wr.instruction || '';
        // ì„œë²„ê°€ snake_case/ camelCase ì–´ëŠ ìª½ì´ë“  í‘œì‹œë˜ë„ë¡ ì²˜ë¦¬
        $('writingExample').value = wr.example_answer || wr.exampleAnswer || '';
    }

    // ---- SIM ----
    function appendBubble(role, text){
        const wrap = $('chat');
        const div = document.createElement('div');
        div.className = `bubble ${role === 'ai' ? 'ai' : 'user'}`;
        div.textContent = text;
        wrap.appendChild(div);
        wrap.scrollTop = wrap.scrollHeight;
    }
    function renderSimStart(sim){
        show('simSec', true);
        $('situation').innerText = sim.situation || '';
        state.situation = sim.situation;
        state.history = [{ role:'ai', text: sim.ai_first_line }];
        $('chat').innerHTML = '';
        appendBubble('ai', sim.ai_first_line || '');
        // ì…ë ¥ í™œì„±í™” ë³´ì¥
        disable('parentReply', false);
        disable('btnSimNext', false);
    }

    // ---- FEEDBACK ----
    function renderFeedback(fb){
        $('fbOverall').textContent = fb.overall_comment || '(ìš”ì•½ ì—†ìŒ)';
        const ul = $('fbTips');
        ul.innerHTML = '';
        (fb.tips || []).forEach(t => {
            const li = document.createElement('li');
            li.textContent = t;
            ul.appendChild(li);
        });
        $('fbSec').style.display = '';
    }
    async function fetchFeedbackAuto(){
        // ìŠ¤í”„ë§: POST /api/workbooks/runs/{runId}/feedback ê°€ì •
        const fb = await req(`/api/workbooks/runs/${state.runId}/feedback`, 'POST', {});
        renderFeedback(fb);
    }

    // ---- ë²„íŠ¼ í•¸ë“¤ëŸ¬ ----
    $('btnClear').onclick = () => { $('log').innerText = ''; };

    $('btnCreate').onclick = async () => {
        try {
            const body = {
                topic: $('topic').value,
                user: { child_age: Number($('childAge').value) || 4 },
                userId: $('userId').value
            };
            const data = await req('/api/workbooks', 'POST', body);
            setState({ workbookId: data.id, runId: null, step: 'CREATED' });

            // í™”ë©´ ì´ˆê¸°í™”
            show('mcqSec', false); show('writingSec', false); show('simSec', false); show('fbSec', false);
            $('chat').innerHTML = '';
            $('parentReply').value = '';
            disable('parentReply', false);
            disable('btnSimNext', false);
        } catch (e) { alert(e.message); }
    };

    $('btnStart').onclick = async () => {
        try {
            if (!state.workbookId) return alert('ë¨¼ì € ì›Œí¬ë¶ì„ ìƒì„±í•˜ì„¸ìš”.');
            const data = await req(`/api/workbooks/${state.workbookId}/run/start`, 'POST', {});
            setState({ runId: data.runId, step: 'MCQ' });
            renderMcq(data.mcq);  // â˜… ë³´ê¸° í‘œì‹œ
        } catch (e) { alert(e.message); }
    };

    $('btnSubmitWriting').onclick = async () => {
        try {
            if (!state.runId) return alert('ë¨¼ì € ëŸ°ì„ ì‹œì‘í•˜ì„¸ìš”.');
            const body = { text: $('writingText').value };
            const data = await req(`/api/workbooks/runs/${state.runId}/answer/writing`, 'POST', body);
            // data: { type: "SIMULATION", situation, ai_first_line }
            renderSimStart(data);
            setState({ step: 'SIM1' });
        } catch (e) { alert(e.message); }
    };

    $('btnSimNext').onclick = async () => {
        try {
            if (!state.runId) return alert('ë¨¼ì € ëŸ°ì„ ì‹œì‘í•˜ì„¸ìš”.');
            const pr = $('parentReply').value;
            if (!pr.trim()) return alert('ë¶€ëª¨ ë°œí™”ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

            // Springâ†’Python: historyì— ë¯¸ë¦¬ ì¶”ê°€í•˜ì§€ ì•ŠìŒ (ì¤‘ë³µ ì¹´ìš´íŠ¸ ë°©ì§€)
            const data = await req(`/api/workbooks/runs/${state.runId}/sim/next`, 'POST', { parentReply: pr });

            // í™”ë©´ì—” ë‚´ê°€ ì¹œ ê±¸ ë¨¼ì € ë³´ì—¬ì£¼ê³ ,
            appendBubble('user', pr);
            $('parentReply').value = '';

            // AI ë¦¬í„´ì´ ìˆìœ¼ë©´ í‘œì‹œ
            if (data.aiLine) appendBubble('ai', data.aiLine);

            if (data.finished) {
                // ì¢…ë£Œì‹œ ì…ë ¥ ë§‰ê³  ìë™ í”¼ë“œë°±
                disable('parentReply', true);
                disable('btnSimNext', true);
                setState({ step: 'FEEDBACK' });
                try {
                    await fetchFeedbackAuto();
                } catch (e) {
                    log('ERROR feedback', { message: e.message }, 'ERR');
                    alert('í”¼ë“œë°± í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } else {
                setState({ step: state.step === 'SIM1' ? 'SIM2' : 'SIM1' });
            }
        } catch (e) { alert(e.message); }
    };
</script>
</body>
</html>
